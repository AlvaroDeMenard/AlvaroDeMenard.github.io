/* sidenotesjs: standalone JS library for parsing HTML documents with Pandoc-style footnotes and dynamically repositioning them into the left/right margins, when browser windows are wide enough.
Sidenotes (see https://www.gwern.net/Sidenotes ) are superior to footnotes where possible because they enable the reader to immediately look at them without requiring user action to 'go to' or 'pop up' the footnotes; even floating footnotes require effort by the reader.
sidenotesjs is inspired by the Tufte-CSS sidenotes (https://edwardtufte.github.io/tufte-css/#sidenotes), but where Tufte-CSS uses static footnotes inlined into the body of the page (requiring modifications to Pandoc's compilation), which doesn't always work well for particularly long or frequent sidenotes, sidenotes.js will rearrange sidenotes to fit as best as possible, and will respond to window changes.
Particularly long sidenotes are also partially 'collapsed'.

Author: Said Achmiz
2019-03-11
license: MIT (derivative of footnotes.js, which is PD)
*/
function GWLog(e){(GW.loggingEnabled||"true"==localStorage.getItem("logging-enabled"))&&console.log(e)}function updateTargetCounterpart(){var e;GWLog("updateTargetCounterpart"),document.querySelectorAll(".targeted").forEach(e=>{e.classList.remove("targeted")}),location.hash.match(/#sn[0-9]/)?e=document.querySelector("#fnref"+location.hash.substr(3)):location.hash.match(/#fnref[0-9]/)&&0==GW.sidenotes.mediaQueries.viewportWidthBreakpoint.matches&&(e=document.querySelector("#sn"+location.hash.substr(6))),e&&e.classList.toggle("targeted",!0)}function isOnScreen(e){let t=e.getBoundingClientRect();return t.top<window.innerHeight&&t.bottom>0&&t.left<window.innerWidth&&t.right>0}function realignHashIfNeeded(){GWLog("realignHashIfNeeded"),(location.hash.match(/#sn[0-9]/)||location.hash.match(/#fnref[0-9]/))&&realignHash()}function realignHash(){GWLog("realignHash");var e=location.hash;history.replaceState(null,null,"#"),location.hash=e}function setHashWithoutScrolling(e){var t;GW.isFirefox&&(t=window.getSelection().getRangeAt(0));let o=window.scrollY;location.hash=e,requestAnimationFrame(()=>{window.scrollTo(0,o)}),GW.isFirefox&&window.getSelection().addRange(t)}function ridiculousWorkaroundsForBrowsersFromBizarroWorld(){if(GWLog("ridiculousWorkaroundsForBrowsersFromBizarroWorld"),GW.isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,GW.isFirefox){GW.maxBodyWidthInCharacterUnits=85,GW.firefoxTargetingSelector="@supports (-moz-user-focus: normal)";let t=parseInt(getComputedStyle(document.body).maxWidth)/GW.maxBodyWidthInCharacterUnits,o=100*t;GW.sidenotes.viewportWidthBreakpointMediaQueryString=`(max-width: ${o}px)`;let n=65*t;GW.sidenotes.mobileViewportWidthBreakpointMediaQueryString=`(max-width: ${n}px)`;var e=document.querySelector("style#sidenotes-browser-workaround");e||((e=document.createElement("style")).id="sidenotes-browser-workaround",document.querySelector("body").appendChild(e)),e.innerHTML=`\n            ${GW.firefoxTargetingSelector} {\n                @media only screen and (max-width: ${o}px) {\n                    #sidenote-column-left,\n                    #sidenote-column-right {\n                        display: none;\n                    }\n                }\n                @media only screen and (min-width: ${o+1}px) {\n                    main {\n                        position: relative;\n                        right: 4ch;\n                    }\n                    .content_container {\n                        position: relative;\n                    }\n                }\n                @media only screen and (max-width: ${o}px) {\n                    .footnote-ref:target {\n                        background-color: inherit;\n                        box-shadow: none;\n                    }\n                }\n            }\n        `}else GW.sidenotes.viewportWidthBreakpointMediaQueryString="(max-width: 155ch)",GW.sidenotes.mobileViewportWidthBreakpointMediaQueryString="(max-width: 65ch)";GW.sidenotes.mediaQueries={viewportWidthBreakpoint:matchMedia(GW.sidenotes.viewportWidthBreakpointMediaQueryString),mobileViewportWidthBreakpoint:matchMedia(GW.sidenotes.mobileViewportWidthBreakpointMediaQueryString),hover:matchMedia("only screen and (hover: hover) and (pointer: fine)")},GW.sidenotes.mediaQueries.viewportWidthBreakpoint.addListener(GW.sidenotes.viewportWidthBreakpointChanged=(()=>{GWLog("GW.sidenotes.viewportWidthBreakpointChanged"),updateFootnoteEventListeners(),GW.sidenotes.footnotesObserver.disconnect(),updateFootnoteReferenceLinks()}))}function isCollapsed(e){return 0==e.querySelector(".disclosure-button").checked}function isWithinCollapsedBlock(e){let t=e.closest(".collapse");return!!t&&(!!isCollapsed(t)||isWithinCollapsedBlock(t.parentElement))}function expandCollapseBlocksToReveal(e){if(GWLog("expandCollapseBlocksToReveal"),!isWithinCollapsedBlock(e))return!1;let t=e.closest(".collapse"),o=t.querySelector(".disclosure-button"),n=0==o.checked;return o.checked=!0,t.classList.toggle("expanded",o.checked),!expandCollapseBlocksToReveal(t.parentElement)&&n&&setTimeout(updateSidenotePositions),n}function revealTarget(){if(GWLog("revealTarget"),!location.hash)return;let e=document.querySelector(decodeURIComponent(location.hash));e&&(expandCollapseBlocksToReveal(location.hash.match(/#sn[0-9]/)?document.querySelector("#fnref"+location.hash.substr(3)):e),e.scrollIntoView())}function updateSidenotesInCollapseBlocks(){GWLog("updateSidenotesInCollapseBlocks");for(var e=$(window).scrollTop(),t=0;t<GW.sidenotes.footnoteRefs.length;t++){let n=GW.sidenotes.footnoteRefs[t],i=GW.sidenotes.sidenoteDivs[t];if(isWithinCollapsedBlock(n)){GW.sidenotes.hiddenSidenoteStorage.appendChild(i);continue}let s=n.getBoundingClientRect().top+e<1600?GW.sidenotes.sidenoteColumnLeft:t%2?GW.sidenotes.sidenoteColumnLeft:GW.sidenotes.sidenoteColumnRight;for(var o=t+2;o<GW.sidenotes.footnoteRefs.length&&GW.sidenotes.sidenoteDivs[o].parentElement==GW.sidenotes.hiddenSidenoteStorage;)o+=2;GW.sidenotes.footnoteRefs.length,s.appendChild(i)}}function updateFootnoteReferenceLinks(){GWLog("updateFootnoteReferenceLinks");for(var e=0;e<GW.sidenotes.footnoteRefs.length;e++){let t=GW.sidenotes.footnoteRefs[e];0==GW.sidenotes.mediaQueries.viewportWidthBreakpoint.matches&&(t.href="#sn"+(e+1))}}function updateFootnoteEventListeners(){if(GWLog("updateFootnoteEventListeners"),0==GW.sidenotes.mediaQueries.viewportWidthBreakpoint.matches){window.Footnotes&&Footnotes.unbind();for(var e=0;e<GW.sidenotes.footnoteRefs.length;e++){let t=GW.sidenotes.footnoteRefs[e],o=GW.sidenotes.sidenoteDivs[e];t.addEventListener("mouseover",GW.sidenotes.footnoteover=(()=>{o.classList.toggle("highlighted",!0)})),t.addEventListener("mouseout",GW.sidenotes.footnoteout=(()=>{o.classList.remove("highlighted")})),o.addEventListener("mouseover",GW.sidenotes.sidenoteover=(()=>{t.classList.toggle("highlighted",!0)})),o.addEventListener("mouseout",GW.sidenotes.sidenoteout=(()=>{t.classList.remove("highlighted")}))}clearFootnotePopups()}else{for(e=0;e<GW.sidenotes.footnoteRefs.length;e++){let t=GW.sidenotes.footnoteRefs[e],o=GW.sidenotes.sidenoteDivs[e];t.removeEventListener("mouseover",GW.sidenotes.footnoteover),t.removeEventListener("mouseout",GW.sidenotes.footnoteout),o.removeEventListener("mouseover",GW.sidenotes.sidenoteover),o.removeEventListener("mouseout",GW.sidenotes.sidenoteout)}window.Footnotes&&0==GW.sidenotes.mediaQueries.mobileViewportWidthBreakpoint.matches&&1==GW.sidenotes.mediaQueries.hover&&Footnotes.setup()}}function clearFootnotePopups(){GWLog("clearFootnotePopups"),document.querySelectorAll("#footnotediv").forEach(e=>{e.remove()})}function updateSidenotePositions(){if(GWLog("updateSidenotePositions"),1==GW.sidenotes.mediaQueries.viewportWidthBreakpoint.matches)return;var e=document.querySelector(".content_container").children[0];let t=e.offsetTop||0;GW.sidenotes.sidenoteColumnLeft.offsetTop<e.offsetTop&&(GW.sidenotes.sidenoteColumnLeft.style.top=t+"px",GW.sidenotes.sidenoteColumnLeft.style.height=`calc(100% - ${t}px)`),updateSidenotesInCollapseBlocks();for(var o=0;o<GW.sidenotes.footnoteRefs.length;o++){let e=GW.sidenotes.sidenoteDivs[o];if(e.parentElement==GW.sidenotes.hiddenSidenoteStorage)continue;let t=GW.sidenotes.footnoteRefs[o].getBoundingClientRect().top<1600?GW.sidenotes.sidenoteColumnLeft:o%2?GW.sidenotes.sidenoteColumnLeft:GW.sidenotes.sidenoteColumnRight;e.style.top=Math.round(GW.sidenotes.footnoteRefs[o].getBoundingClientRect().top-t.getBoundingClientRect().top+4)+"px";let n=e.firstElementChild;e.classList.toggle("cut-off",n.scrollHeight>n.clientHeight+2)}var n=[];let i=GW.sidenotes.sidenoteColumnRight.getBoundingClientRect();GW.sidenotes.potentiallyOverlappingElementsSelector=".marginnote, .tableWrapper.full-width, figure.full-width",document.querySelectorAll(GW.sidenotes.potentiallyOverlappingElementsSelector).forEach(e=>{let t=e.getBoundingClientRect();n.push({top:t.top-i.top,bottom:t.bottom-i.top})}),n.push({top:GW.sidenotes.sidenoteColumnRight.clientHeight,bottom:GW.sidenotes.sidenoteColumnRight.clientHeight});for(o=0;o<GW.sidenotes.footnoteRefs.length;o++){let e=GW.sidenotes.sidenoteDivs[o],t=e.nextElementSibling;if(e.parentElement==GW.sidenotes.hiddenSidenoteStorage)continue;let i=e.offsetTop<1500?GW.sidenotes.sidenoteColumnLeft:o%2?GW.sidenotes.sidenoteColumnLeft:GW.sidenotes.sidenoteColumnRight,u={ceiling:i==GW.sidenotes.sidenoteColumnLeft?0:1350,floor:i.clientHeight},h={top:e.offsetTop-GW.sidenotes.sidenoteSpacing,bottom:e.offsetTop+e.clientHeight+GW.sidenotes.sidenoteSpacing},p=(h.top+h.bottom)/2;for(var s=-1,d=0;d<n.length;d++){let e={top:n[d].top-i.offsetTop,bottom:n[d].bottom-i.offsetTop};e.halfwayPoint=(e.top+e.bottom)/2,e.halfwayPoint<p&&(u.ceiling=e.bottom);let t=n.length-d-1,o={top:n[t].top-i.offsetTop,bottom:n[t].bottom-i.offsetTop};o.halfwayPoint=(o.top+o.bottom)/2,o.halfwayPoint>p&&(u.floor=o.top,s=t)}if(GWLog(`Sidenote ${o+1}’s room is: (${u.ceiling}, ${u.floor}).`),h.bottom-h.top>u.floor-u.ceiling){if(-1==s)return void GWLog("TOO MUCH SIDENOTES. GIVING UP. :(");e.style.top=n[s].bottom+GW.sidenotes.sidenoteSpacing+"px",o--;continue}var r=u.ceiling-h.top;r>0&&(GWLog(`Sidenote ${e.id.substr(2)} overlaps its ceiling!`),e.style.top=parseInt(e.style.top)+r+"px",h.top+=r,h.bottom+=r);var a=h.bottom-u.floor;a>0&&GWLog(`Sidenote ${e.id.substr(2)} overlaps its floor!`);var l=t?h.bottom-t.offsetTop:-1;l>0&&GWLog(`Sidenote ${e.id.substr(2)} overlaps sidenote ${t.id.substr(2)}!`);var c=Math.max(l,a);if(c<=0)continue;let g=e.previousElementSibling,f=h.top-u.ceiling,W=g?Math.min(f,h.top-(g.offsetTop+g.clientHeight)):f;GWLog(`We have ${W}px of headroom.`),W>=c?(GWLog(`There is enough headroom. Moving sidenote ${e.id.substr(2)} up.`),e.style.top=parseInt(e.style.top)-c+"px"):(GWLog(`There is not enough headroom to move sidenote ${e.id.substr(2)} all the way up!`),W<a?(e.style.top=n[s].bottom+GW.sidenotes.sidenoteSpacing+"px",o--):h.bottom+t.clientHeight+GW.sidenotes.sidenoteSpacing-W>n[s].top||(GWLog(`Moving sidenote ${e.id.substr(2)} up by ${W} pixels...`),e.style.top=parseInt(e.style.top)-W+"px",l-=W,GWLog(`... and moving sidenote ${t.id.substr(2)} down by ${l} pixels.`),t.style.top=parseInt(t.style.top)+l+"px"))}GW.sidenotes.sidenoteColumnLeft.style.visibility="",GW.sidenotes.sidenoteColumnRight.style.visibility=""}function constructSidenotes(){GWLog("constructSidenotes");let e=document.querySelector(".content_container");if(e){GW.sidenotes.sidenoteColumnLeft&&GW.sidenotes.sidenoteColumnLeft.remove(),GW.sidenotes.sidenoteColumnRight&&GW.sidenotes.sidenoteColumnRight.remove(),e.insertAdjacentHTML("beforeend","<div id='sidenote-column-left' class='footnotes' style='visibility:hidden'></div><div id='sidenote-column-right' class='footnotes' style='visibility:hidden'></div>"),GW.sidenotes.sidenoteColumnLeft=document.querySelector("#sidenote-column-left"),GW.sidenotes.sidenoteColumnRight=document.querySelector("#sidenote-column-right"),GW.sidenotes.sidenoteDivs=[],GW.sidenotes.footnoteRefs=Array.from(document.querySelectorAll("a.footnote-ref"));for(var t=0;t<GW.sidenotes.footnoteRefs.length;t++){let e=document.createElement("div");e.classList.add("sidenote"),e.id="sn"+(t+1);let o=document.querySelector(GW.sidenotes.footnoteRefs[t].hash);e.innerHTML="<div class='sidenote-outer-wrapper'><div class='sidenote-inner-wrapper'>"+(o?o.querySelector(".footnote-contents").innerHTML:"Loading sidenote contents, please wait…")+"</div></div>",GW.sidenotes.sidenoteDivs.push(e),(t%2?GW.sidenotes.sidenoteColumnLeft:GW.sidenotes.sidenoteColumnRight).appendChild(e)}for(t=0;t<GW.sidenotes.footnoteRefs.length;t++){let e=document.createElement("a");e.classList.add("sidenote-self-link"),e.href="#sn"+(t+1),e.textContent=GW.sidenotes.footnoteRefs[t].innerText,GW.sidenotes.sidenoteDivs[t].appendChild(e)}GW.sidenotes.hiddenSidenoteStorage&&GW.sidenotes.hiddenSidenoteStorage.remove(),GW.sidenotes.hiddenSidenoteStorage=document.createElement("div"),GW.sidenotes.hiddenSidenoteStorage.id="hidden-sidenote-storage",GW.sidenotes.hiddenSidenoteStorage.style.display="none",e.appendChild(GW.sidenotes.hiddenSidenoteStorage);for(t=0;t<GW.sidenotes.footnoteRefs.length;t++){let e=GW.sidenotes.sidenoteDivs[t];e.addEventListener("click",GW.sidenotes.sidenoteClicked=(t=>{GWLog("GW.sidenotes.sidenoteClicked"),decodeURIComponent(location.hash)!=e.id&&"A"!=t.target.tagName&&(location.hash.hasPrefix("#sn")||location.hash.hasPrefix("#fnref")||(GW.sidenotes.hashBeforeSidenoteWasFocused=location.hash),setHashWithoutScrolling(encodeURIComponent(e.id)))}))}GW.sidenotes.problematicCharacters="/=≠",GW.sidenotes.sidenoteDivs.forEach(e=>{e.querySelectorAll("*").forEach(e=>{e.closest(".sourceCode")||e.childNodes.forEach(e=>{e.childNodes.length>0||(e.textContent=e.textContent.replace(new RegExp("(\\w["+GW.sidenotes.problematicCharacters+"])(\\w)","g"),"$1​$2"))})})})}}function sidenotesSetup(){GWLog("sidenotesSetup"),GW.sidenotes={sidenoteSpacing:30},ridiculousWorkaroundsForBrowsersFromBizarroWorld(),GW.isFirefox&&"complete"!=document.readyState&&window.addEventListener("load",ridiculousWorkaroundsForBrowsersFromBizarroWorld),constructSidenotes(),"loading"==document.readyState&&window.addEventListener("DOMContentLoaded",constructSidenotes),window.addEventListener("resize",GW.sidenotes.windowResized=(e=>{GWLog("GW.sidenotes.windowResized"),updateSidenotePositions()})),"complete"==document.readyState?updateSidenotePositions():("loading"==document.readyState?window.addEventListener("DOMContentLoaded",updateSidenotePositions):updateSidenotePositions(),window.addEventListener("load",updateSidenotePositions)),"complete"==document.readyState?(updateFootnoteEventListeners(),updateFootnoteReferenceLinks()):window.addEventListener("load",()=>{updateFootnoteEventListeners(),updateFootnoteReferenceLinks()}),GW.sidenotes.footnotesObserver=new MutationObserver((e,t)=>{document.querySelector("#footnotediv")&&(updateFootnoteEventListeners(),GW.sidenotes.footnotesObserver.disconnect())}),GW.sidenotes.footnotesObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0}),location.hash.match(/#sn[0-9]/)&&1==GW.sidenotes.mediaQueries.viewportWidthBreakpoint.matches?location.hash="#fn"+location.hash.substr(3):location.hash.match(/#fn[0-9]/)&&0==GW.sidenotes.mediaQueries.viewportWidthBreakpoint.matches?location.hash="#sn"+location.hash.substr(3):requestAnimationFrame(realignHashIfNeeded),window.addEventListener("hashchange",GW.sidenotes.hashChanged=(()=>{GWLog("GW.sidenotes.hashChanged"),revealTarget(),updateTargetCounterpart()})),window.addEventListener("load",()=>{revealTarget(),updateTargetCounterpart()}),document.querySelectorAll(".disclosure-button").forEach(e=>{e.addEventListener("change",GW.sidenotes.disclosureButtonValueChanged=(e=>{GWLog("GW.sidenotes.disclosureButtonValueChanged"),setTimeout(updateSidenotePositions)}))}),GW.sidenotes.hashBeforeSidenoteWasFocused=location.hash.hasPrefix("#sn")||location.hash.hasPrefix("#fnref")?"":location.hash,document.body.addEventListener("click",GW.sidenotes.bodyClicked=(e=>{GWLog("GW.sidenotes.bodyClicked"),"A"==e.target.tagName||e.target.closest(".sidenote")||!location.hash.hasPrefix("#sn")&&!location.hash.hasPrefix("#fnref")||setHashWithoutScrolling(GW.sidenotes.hashBeforeSidenoteWasFocused)}))}void 0===window.GW&&(window.GW={}),GW.enableLogging=((e=!1)=>{e?localStorage.setItem("logging-enabled","true"):GW.loggingEnabled=!0}),GW.disableLogging=((e=!1)=>{e?localStorage.removeItem("logging-enabled"):GW.loggingEnabled=!1}),String.prototype.hasPrefix=function(e){return 0===this.lastIndexOf(e,0)},sidenotesSetup();